<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelAI ç”»å¸ˆå†›ç«åº“ v7.0</title>
    <style>
        :root {
            --primary: #4a90e2;
            --primary-hover: #357abd;
            --selected: #ff6b6b;
            --fav: #f1c40f;
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text: #333;
            --sub-text: #666;
            --border: #ddd;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --chip-bg: #eef2f7;
            --chip-text: #333;
        }

        body.dark-mode {
            --primary: #64b5f6;
            --primary-hover: #42a5f5;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --sub-text: #a0a0a0;
            --border: #333;
            --shadow: 0 4px 20px rgba(0,0,0,0.5);
            --chip-bg: #2d2d2d;
            --chip-text: #ddd;
        }

        /* === æ€§èƒ½ä¼˜åŒ–ï¼šåªå¯¹é¢œè‰²åšè¿‡æ¸¡ï¼Œé¿å…é‡æ’å¯¼è‡´çš„å¡é¡¿ === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; padding-bottom: 160px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1 { text-align: center; font-weight: 300; letter-spacing: 1px; margin-bottom: 20px; }

        /* === å¸ƒå±€ === */
        .controls {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            margin-bottom: 30px; background: var(--card-bg); padding: 20px;
            border-radius: 16px; box-shadow: var(--shadow);
            max-width: 1000px; margin-left: auto; margin-right: auto; align-items: center;
            transition: background-color 0.3s ease;
        }

        /* æœç´¢æ¡† */
        .search-wrapper { flex-grow: 1; min-width: 300px; position: relative; }
        #search {
            width: 90%; padding: 12px 15px; padding-right: 40px; border-radius: 25px;
            border: 1px solid var(--border); font-size: 15px; background: var(--bg); color: var(--text);
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
        }
        #search:focus { border-color: var(--primary); outline: none; }
        .shortcut-hint {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            font-size: 12px; color: var(--sub-text); border: 1px solid var(--border);
            padding: 2px 6px; border-radius: 4px; pointer-events: none;
        }

        /* æŒ‰é’®ç»„ */
        .settings-group { display: flex; gap: 10px; align-items: center; }
        .btn-toggle {
            padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border);
            background: var(--card-bg); color: var(--sub-text); cursor: pointer;
            display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .btn-toggle:hover { filter: brightness(0.95); }
        .btn-toggle.active { background: #e3f2fd; border-color: var(--primary); color: var(--primary); }
        .btn-toggle-fav.active { background: #fff9db; border-color: var(--fav); color: #d35400; }
        
        /* æš—é»‘æ¨¡å¼æŒ‰é’®å¾®è°ƒ */
        body.dark-mode .btn-toggle.active { background: #153552; }
        body.dark-mode .btn-toggle-fav.active { background: #3d3512; color: #f1c40f; }

        /* å‰ç¼€å¼€å…³ */
        .switch-label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--sub-text); cursor: pointer; user-select: none; }
        .switch-input { display: none; }
        .switch-slider { width: 36px; height: 20px; background-color: #ccc; border-radius: 20px; position: relative; transition: 0.3s; }
        .switch-slider::before { content: ""; position: absolute; width: 16px; height: 16px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: 0.3s; }
        .switch-input:checked + .switch-slider { background-color: var(--primary); }
        .switch-input:checked + .switch-slider::before { transform: translateX(16px); }

        /* æŠ½å¡ */
        .gacha-box { display: flex; align-items: center; gap: 8px; padding-left: 15px; border-left: 1px solid var(--border); }
        #gacha-count { width: 45px; padding: 6px; border-radius: 6px; border: 1px solid var(--border); text-align: center; background: var(--bg); color: var(--text); }
        .btn-gacha { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: transform 0.1s; }
        .btn-gacha:hover { transform: translateY(-1px); }

        /* === å·¦ä¾§å­—æ¯ç´¢å¼•è¡¨ === */
        #alpha-nav {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 2px; z-index: 90;
            background: var(--card-bg); padding: 5px; border-radius: 20px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            max-height: 90vh; overflow-y: auto; opacity: 0.6; transition: opacity 0.3s;
        }
        #alpha-nav:hover { opacity: 1; }
        .alpha-link {
            text-decoration: none; color: var(--sub-text); font-size: 11px; font-weight: bold;
            padding: 2px 6px; border-radius: 4px; text-align: center; cursor: pointer;
        }
        .alpha-link:hover { background: var(--primary); color: white; }
        .alpha-header { grid-column: 1 / -1; font-size: 24px; font-weight: bold; color: var(--sub-text); margin-top: 20px; border-bottom: 2px solid var(--border); padding-bottom: 5px; }

        /* === ç½‘æ ¼ä¸å¡ç‰‡ === */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }

        .card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; /* ç§»é™¤ background transition æå‡æ€§èƒ½ */
            position: relative; border: 2px solid transparent; display: flex; flex-direction: column;
            content-visibility: auto; contain-intrinsic-size: 1px 250px;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .card.selected { border-color: var(--selected); background-color: rgba(255, 107, 107, 0.08); }

        .card-img-wrapper { width: 100%; height: 200px; cursor: zoom-in; background: #333; position: relative; overflow: hidden; }
        .card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
        .card img.loaded { opacity: 1; }

        .card-actions { position: absolute; top: 6px; right: 6px; display: flex; flex-direction: column; gap: 6px; z-index: 10; }
        .action-btn {
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.95);
            border: 1px solid #ddd; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: transform 0.2s; text-decoration: none;
        }
        body.dark-mode .action-btn { background: rgba(40,40,40,0.9); border-color: #555; color: #ccc; }
        .action-btn:hover { transform: scale(1.1); }
        
        /* é€‰ä¸­çŠ¶æ€çš„å‹¾å‹¾ - é«˜äº®ä¼˜åŒ– */
        .btn-select.active { background: var(--selected) !important; border-color: var(--selected) !important; color: white !important; }
        .btn-fav.active { color: var(--fav) !important; border-color: var(--fav) !important; }

        .card-info { padding: 12px; text-align: center; border-top: 1px solid var(--border); flex-grow: 1; display: flex; align-items: center; justify-content: center; cursor: pointer;}
        .artist-name { font-weight: 600; font-size: 14px; word-break: break-all; color: var(--text); }
        .card.selected .artist-name { color: var(--selected); }

        /* === è´­ç‰©è½¦ (å‡çº§ç‰ˆ) === */
        #cart-bar {
            position: fixed; bottom: -250px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 950px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            z-index: 100; transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; gap: 12px; border: 1px solid rgba(255,255,255,0.3);
        }
        body.dark-mode #cart-bar { background: rgba(30, 30, 30, 0.95); border-color: #444; }
        #cart-bar.show { bottom: 20px; }

        /* ç”»å¸ˆ Chip åˆ—è¡¨ */
        .cart-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; min-height: 50px; align-items: center; }
        
        /* æ–°ç‰ˆ Chip æ ·å¼ */
        .cart-chip {
            background: var(--chip-bg); color: var(--chip-text); border-radius: 6px;
            display: flex; align-items: center; font-size: 13px; border: 1px solid var(--border);
            user-select: none; transition: background 0.2s;
        }
        .cart-chip.dragging { opacity: 0.5; border: 1px dashed var(--primary); }
        .cart-chip:hover { border-color: var(--primary); background: var(--card-bg); }

        /* æ‹–æ‹½æ‰‹æŸ„ */
        .drag-handle {
            padding: 8px 8px; cursor: grab; color: var(--sub-text); border-right: 1px solid var(--border);
            font-size: 16px; line-height: 1; display: flex; align-items: center;
        }
        .drag-handle:active { cursor: grabbing; }
        
        /* æƒé‡æŒ‰é’® - / + */
        .weight-btn {
            border: none; background: transparent; color: var(--sub-text); cursor: pointer;
            padding: 0 6px; font-weight: bold; font-size: 14px;
        }
        .weight-btn:hover { color: var(--primary); background: rgba(0,0,0,0.05); }

        /* åå­— */
        .chip-name { padding: 8px 6px; font-weight: 600; cursor: pointer; }
        
        /* åˆ é™¤æŒ‰é’® */
        .remove-btn {
            padding: 8px 10px; cursor: pointer; color: #999; border-left: 1px solid var(--border); font-size: 16px;
        }
        .remove-btn:hover { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }

        /* åº•éƒ¨æ“ä½œæ  */
        .cart-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; }
        .cart-btn {
            border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s;
        }
        .btn-copy { background: var(--primary); color: white; }
        .btn-copy:hover { background: var(--primary-hover); }
        .btn-clear { background: #eee; color: #555; }
        body.dark-mode .btn-clear { background: #444; color: #ddd; }
        .btn-batch-fav { background: #fff9db; color: #d35400; border: 1px solid #ffeaa7; }
        body.dark-mode .btn-batch-fav { background: #3d3512; color: #f1c40f; border-color: #554e15; }

        /* æ‚¬æµ®é¢„è§ˆ & ç¯ç®± & å…¶ä»– */
        #hover-preview {
            position: fixed; pointer-events: none; z-index: 2000; width: 140px; height: 140px;
            background: #000; border: 2px solid white; border-radius: 8px; overflow: hidden;
            opacity: 0; transform: scale(0.8) translateY(10px); transition: 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #hover-preview.show { opacity: 1; transform: scale(1) translateY(0); }
        #hover-preview img { width: 100%; height: 100%; object-fit: cover; }

        #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; }
        #lightbox.open { display: flex; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; }
        .lightbox-content img { max-width: 100%; max-height: 90vh; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .lightbox-link { position: absolute; bottom: 20px; right: 20px; background: #0075d8; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .back-to-top {
            position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%;
            background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 90; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .back-to-top.show { opacity: 1; visibility: visible; bottom: 40px; }

        .btn-gallery { background: #2ecc71; color: white; border: none; margin: 0 auto 20px; padding: 8px 20px; border-radius: 20px; font-weight: bold; display: block; width: fit-content; text-decoration: none; transition: 0.2s; }
        .btn-gallery:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        
        .toast { visibility: hidden; min-width: 200px; background: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 4000; left: 50%; top: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        .toast.show { visibility: visible; opacity: 1; top: 40px; }
        
        /* ä¾§è¾¹æ å†å² */
        #history-panel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: var(--card-bg); z-index: 2000; transition: right 0.3s; box-shadow: -5px 0 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        #history-panel.open { right: 0; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 10px; border: 1px solid var(--border); margin-bottom: 5px; border-radius: 6px; cursor: pointer; }
        .history-item:hover { border-color: var(--primary); }
        #overlay { display: none; position: fixed; inset: 0; z-index: 1999; }
    </style>
</head>
<body>

    <h1>NovelAI ç”»å¸ˆå†›ç«åº“</h1>
    
    <a href="gallery.html" class="btn-gallery">âœ¨ æŸ¥çœ‹æˆ‘çš„ç²¾é€‰ Prompt å›¾åº“</a>

    <!-- å·¦ä¾§ A-Z ç´¢å¼• -->
    <div id="alpha-nav"></div>

    <div class="controls">
        <div class="search-wrapper">
            <input type="text" id="search" placeholder="è¾“å…¥ç”»å¸ˆå / ç²˜è´´ Prompt...">
            <div class="shortcut-hint">/</div>
        </div>
        
        <div class="settings-group">
            <button class="btn-toggle" onclick="toggleHistory()" title="å†å²">ğŸ•’</button>
            <button class="btn-toggle" onclick="toggleDarkMode()" title="å¤œé—´æ¨¡å¼">ğŸŒ—</button>
            <button class="btn-toggle btn-toggle-fav" id="btn-show-fav" onclick="toggleShowFav()" title="æ”¶è—">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </button>
            <label class="switch-label">
                <input type="checkbox" id="check-prefix" class="switch-input" checked onchange="savePrefixSetting()">
                <div class="switch-slider"></div>
                <span style="font-size:12px">å‰ç¼€</span>
            </label>
        </div>

        <div class="gacha-box">
            <input type="number" id="gacha-count" value="3" min="1" max="50">
            <button class="btn-gacha" onclick="gacha()">ğŸ² å¸®æˆ‘é€‰</button>
        </div>
    </div>

    <div class="grid" id="gallery"></div>

    <!-- åº•éƒ¨è´­ç‰©è½¦ (æ”¯æŒæ‹–æ‹½æ’åº + æƒé‡) -->
    <div id="cart-bar">
        <div class="cart-list" id="cart-list"></div>
        <div class="cart-footer">
            <div class="cart-info">å·²é€‰ <span id="cart-count">0</span> ä½</div>
            <div class="cart-actions">
                <button class="cart-btn btn-batch-fav" onclick="batchFav()">â­ æ”¶è—å…¨éƒ¨</button>
                <button class="cart-btn btn-clear" onclick="clearCart()">æ¸…ç©º</button>
                <button class="cart-btn btn-copy" onclick="copyCart()">å¤åˆ¶ç»„åˆ</button>
            </div>
        </div>
    </div>

    <div id="hover-preview"><img src=""></div>
    <div id="history-panel">
        <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; display:flex; justify-content:space-between;">
            <span>ğŸ“‹ å¤åˆ¶å†å²</span><span onclick="toggleHistory()" style="cursor:pointer">Ã—</span>
        </div>
        <div class="history-list" id="history-list"></div>
        <div style="padding:10px; text-align:center; border-top:1px solid var(--border);">
            <button class="cart-btn btn-clear" style="width:100%" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>
    </div>
    <div id="overlay" onclick="toggleHistory()"></div>

    <button id="backToTop" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>
    </button>

    <div id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="">
            <a id="lightbox-link" href="#" target="_blank" class="lightbox-link">â†— Danbooru</a>
        </div>
    </div>
    <div id="toast" class="toast">æç¤º</div>

    <script>
        // === å…¨å±€æ•°æ® ===
        const ICON_CHECK = 'âœ“';
        const ICON_STAR = '<svg viewBox="0 0 24 24" width="16" height="16"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"/></svg>';
        const ICON_LINK = 'â†—';

        let allArtists = [];
        let artistImageMap = {}; 
        let artistNameSet = new Set();
        
        // æ ¸å¿ƒè´­ç‰©è½¦æ•°æ®ç»“æ„ï¼šArray ä¿è¯é¡ºåº
        // æ ¼å¼: [{name: 'wlop', weight: 0}, {name: 'nixeu', weight: 1}]
        // weight: 0=normal, 1={}, 2={{}}, -1=[], -2=[[]]
        let cartItems = []; 
        let selectedSet = new Set(); // è¾…åŠ© Setï¼Œç”¨äº O(1) åˆ¤æ–­æ˜¯å¦é€‰ä¸­

        let favArtists = new Set(JSON.parse(localStorage.getItem('favArtists') || '[]'));
        let isFavOnly = false;
        let copyHistory = JSON.parse(localStorage.getItem('copyHistory') || '[]');

        // åˆå§‹åŒ–
        if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
        if (localStorage.getItem('usePrefix') === 'false') document.getElementById('check-prefix').checked = false;

        window.addEventListener('scroll', () => {
            document.getElementById('backToTop').classList.toggle('show', window.scrollY > 300);
        });

        fetch('artist_data.json').then(res=>res.json()).then(data => {
            allArtists = data.sort((a,b) => a.name.localeCompare(b.name));
            data.forEach(item => {
                artistImageMap[item.name] = item.image;
                artistNameSet.add(item.name.toLowerCase());
            });
            renderAlphabet();
            render();
        });

        // === è´­ç‰©è½¦é€»è¾‘ (é‡æ„ç‰ˆ) ===

        function toggleSelection(name) {
            if (selectedSet.has(name)) {
                // ç§»é™¤
                selectedSet.delete(name);
                cartItems = cartItems.filter(i => i.name !== name);
            } else {
                // æ·»åŠ  (é»˜è®¤æƒé‡ 0)
                selectedSet.add(name);
                cartItems.push({ name: name, weight: 0 });
            }
            render(); // åˆ·æ–°ç½‘æ ¼çŠ¶æ€
            updateCartUI(); // åˆ·æ–°è´­ç‰©è½¦ UI
        }

        // æ”¹å˜æƒé‡
        function changeWeight(index, delta) {
            const item = cartItems[index];
            item.weight += delta;
            if (item.weight > 3) item.weight = 3; // é™åˆ¶æœ€å¤§ {{}}
            if (item.weight < -3) item.weight = -3;
            updateCartUI();
        }

        // æ¸²æŸ“è´­ç‰©è½¦ UI (å«æ‹–æ‹½)
        function updateCartUI() {
            const listEl = document.getElementById('cart-list');
            listEl.innerHTML = '';
            
            cartItems.forEach((item, index) => {
                const chip = document.createElement('div');
                chip.className = 'cart-chip';
                chip.draggable = true; // å¼€å¯æ‹–æ‹½
                
                // æ ¼å¼åŒ–åå­—æ˜¾ç¤º
                let displayName = item.name;
                if (item.weight > 0) displayName = "{".repeat(item.weight) + item.name + "}".repeat(item.weight);
                if (item.weight < 0) displayName = "[".repeat(Math.abs(item.weight)) + item.name + "]".repeat(Math.abs(item.weight));

                chip.innerHTML = `
                    <div class="drag-handle" title="æ‹–æ‹½æ’åº">â‰¡</div>
                    <button class="weight-btn" onclick="changeWeight(${index}, -1)">-</button>
                    <span class="chip-name">${displayName}</span>
                    <button class="weight-btn" onclick="changeWeight(${index}, 1)">+</button>
                    <div class="remove-btn" onclick="toggleSelection('${item.name}')">Ã—</div>
                `;

                // æ‚¬åœé¢„è§ˆ
                const nameEl = chip.querySelector('.chip-name');
                nameEl.onmouseenter = (e) => showHoverPreview(e, item.name);
                nameEl.onmouseleave = hideHoverPreview;
                nameEl.onclick = () => openLightbox(artistImageMap[item.name], item.name);

                // === æ‹–æ‹½äº‹ä»¶ç›‘å¬ ===
                chip.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', index); // å­˜å½“å‰ç´¢å¼•
                    chip.classList.add('dragging');
                });
                chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
                
                chip.addEventListener('dragover', (e) => {
                    e.preventDefault(); // å…è®¸ Drop
                    e.dataTransfer.dropEffect = 'move';
                });

                chip.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = index;
                    if (fromIndex !== toIndex) {
                        // ç§»åŠ¨æ•°ç»„å…ƒç´ 
                        const movedItem = cartItems.splice(fromIndex, 1)[0];
                        cartItems.splice(toIndex, 0, movedItem);
                        updateCartUI(); // é‡ç»˜
                    }
                });

                listEl.appendChild(chip);
            });

            document.getElementById('cart-count').innerText = cartItems.length;
            const bar = document.getElementById('cart-bar');
            cartItems.length > 0 ? bar.classList.add('show') : bar.classList.remove('show');
        }

        function copyCart() {
            if (cartItems.length === 0) return;
            const prefix = document.getElementById('check-prefix').checked ? 'artist:' : '';
            
            const tags = cartItems.map(item => {
                let s = prefix + item.name;
                if (item.weight > 0) s = "{".repeat(item.weight) + s + "}".repeat(item.weight);
                if (item.weight < 0) s = "[".repeat(Math.abs(item.weight)) + s + "]".repeat(Math.abs(item.weight));
                return s;
            }).join(', ');
            
            copyText(tags, `å·²å¤åˆ¶ ${cartItems.length} ä½ç”»å¸ˆç»„åˆï¼`);
        }

        function clearCart() {
            selectedSet.clear();
            cartItems = [];
            render();
            updateCartUI();
        }

        // === å·¦ä¾§å­—æ¯ç´¢å¼• ===
        function renderAlphabet() {
            const nav = document.getElementById('alpha-nav');
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            nav.innerHTML = "";
            letters.forEach(l => {
                const link = document.createElement('div');
                link.className = 'alpha-link';
                link.innerText = l;
                link.onclick = () => {
                    // åªæœ‰åœ¨æ²¡è¿‡æ»¤æ—¶è·³è½¬æ‰å‡†ç¡®
                    if(document.getElementById('search').value || isFavOnly) {
                        showToast("è¯·å…ˆæ¸…ç©ºæœç´¢å’Œç­›é€‰");
                        return;
                    }
                    const target = document.getElementById(`letter-${l}`);
                    if(target) target.scrollIntoView({behavior: "smooth", block: "center"});
                };
                nav.appendChild(link);
            });
        }

        // === æ ¸å¿ƒæ¸²æŸ“ (é€‚é…å­—æ¯ç´¢å¼•) ===
        function render() {
            gallery.innerHTML = '';
            let rawTerm = document.getElementById('search').value;
            let filtered = [];
            let isFiltering = rawTerm || isFavOnly;

            // æœç´¢é€»è¾‘
            if (rawTerm.includes(',') || rawTerm.includes('ï¼Œ')) {
                // æ‰¹é‡è§£æé€»è¾‘... (ç®€ç•¥å†™)
                const segs = rawTerm.split(/[,ï¼Œ]/);
                const found = new Set();
                segs.forEach(s => {
                    let c = s.toLowerCase().trim().replace(/artist:/g,'').replace(/[\[\]\{\}]/g,'');
                    if(artistNameSet.has(c)) found.add(c);
                });
                filtered = allArtists.filter(i => found.has(i.name.toLowerCase()));
            } else {
                let term = rawTerm.toLowerCase().trim();
                filtered = allArtists.filter(i => i.name.toLowerCase().includes(term));
            }
            if (isFavOnly) filtered = filtered.filter(i => favArtists.has(i.name));

            if (filtered.length === 0) { gallery.innerHTML = "<p style='text-align:center;width:100%;color:#999'>æ— ç»“æœ</p>"; return; }

            // æ¸²æŸ“åˆ—è¡¨ (å¸¦å­—æ¯æ ‡é¢˜)
            let lastLetter = "";
            filtered.forEach(item => {
                // å¦‚æœæ²¡æœ‰è¿‡æ»¤ï¼Œä¸”é¦–å­—æ¯å˜äº†ï¼Œæ’å…¥æ ‡é¢˜
                if (!isFiltering) {
                    const currentLetter = item.name.charAt(0).toUpperCase();
                    if (/^[A-Z]/.test(currentLetter) && currentLetter !== lastLetter) {
                        lastLetter = currentLetter;
                        const header = document.createElement('div');
                        header.className = 'alpha-header';
                        header.id = `letter-${lastLetter}`;
                        header.innerText = lastLetter;
                        gallery.appendChild(header);
                    }
                }

                // ç”Ÿæˆå¡ç‰‡ (ä¸ä¹‹å‰é€»è¾‘ä¸€è‡´)
                const isSelected = selectedSet.has(item.name);
                const isFav = favArtists.has(item.name);
                const card = document.createElement('div');
                card.className = `card ${isSelected ? 'selected' : ''}`;
                card.dataset.name = item.name;

                const actions = document.createElement('div'); actions.className = 'card-actions';
                actions.append(
                    createBtn('btn-select', isSelected, ICON_CHECK, () => toggleSelection(item.name)),
                    createBtn('btn-fav', isFav, ICON_STAR, () => toggleFav(item.name)),
                    createLinkBtn(item.name)
                );

                const imgWrapper = document.createElement('div'); imgWrapper.className = 'card-img-wrapper';
                imgWrapper.onclick = () => openLightbox(item.image, item.name);
                const img = document.createElement('img'); img.loading = "lazy"; img.src = item.image;
                img.onload = () => img.classList.add('loaded');
                img.onerror = function() { this.src = 'https://via.placeholder.com/200'; this.classList.add('loaded'); };
                imgWrapper.appendChild(img);

                const info = document.createElement('div'); info.className = 'card-info';
                info.innerHTML = `<span class="artist-name">${item.name}</span>`;
                info.onclick = () => copySingle(item.name);

                card.append(actions, imgWrapper, info);
                gallery.appendChild(card);
            });
            
            // éšè—æˆ–æ˜¾ç¤ºå·¦ä¾§ç´¢å¼•
            document.getElementById('alpha-nav').style.display = isFiltering ? 'none' : 'flex';
        }

        // === è¾…åŠ©å‡½æ•° ===
        function createBtn(cls, active, html, cb) {
            const d = document.createElement('div'); d.className = `action-btn ${cls} ${active ? 'active' : ''}`;
            d.innerHTML = html; d.onclick = (e) => { e.stopPropagation(); cb(); }; return d;
        }
        function createLinkBtn(name) {
            const a = document.createElement('a'); a.className = 'action-btn'; a.innerHTML = 'â†—';
            a.href = `https://danbooru.donmai.us/posts?tags=${name}`; a.target = "_blank"; a.onclick = e => e.stopPropagation(); return a;
        }

        // æ‚¬æµ®é¢„è§ˆ
        function showHoverPreview(e, name) {
            const p = document.getElementById('hover-preview');
            p.querySelector('img').src = artistImageMap[name];
            p.classList.add('show');
            const rect = e.target.getBoundingClientRect();
            p.style.left = (rect.left + rect.width/2 - 70) + 'px';
            p.style.top = (rect.top - 150) + 'px';
        }
        function hideHoverPreview() { document.getElementById('hover-preview').classList.remove('show'); }

        // å…¶ä»–åŠŸèƒ½
        function toggleFav(name) {
            if(favArtists.has(name)) favArtists.delete(name); else favArtists.add(name);
            localStorage.setItem('favArtists', JSON.stringify([...favArtists]));
            if(isFavOnly) render(); else render(); // å¼ºåˆ¶åˆ·æ–°æ˜Ÿæ˜Ÿ
        }
        function toggleShowFav() { isFavOnly = !isFavOnly; document.getElementById('btn-show-fav').classList.toggle('active'); render(); }
        function batchFav() {
            cartItems.forEach(i => favArtists.add(i.name));
            localStorage.setItem('favArtists', JSON.stringify([...favArtists]));
            render(); showToast("å·²æ‰¹é‡æ”¶è—");
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        function gacha() {
            let pool = isFavOnly ? Array.from(favArtists) : allArtists.map(a => a.name);
            let count = Math.min(parseInt(document.getElementById('gacha-count').value)||3, 50);
            for(let i=0; i<count; i++) {
                let r = pool[Math.floor(Math.random()*pool.length)];
                if(!selectedSet.has(r)) toggleSelection(r);
            }
            showToast("æŠ½å–å®Œæˆ");
        }
        function copyText(t,m) { navigator.clipboard.writeText(t).then(()=>{ showToast(m); addToHistory(t); }); }
        function showToast(m) { const t=document.getElementById("toast"); t.innerText=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000); }
        function toggleHistory() { document.getElementById('history-panel').classList.toggle('open'); document.getElementById('overlay').style.display = document.getElementById('history-panel').classList.contains('open') ? 'block':'none'; renderHistory(); }
        function renderHistory() {
            const list=document.getElementById('history-list'); list.innerHTML='';
            copyHistory.forEach(h => {
                let d=document.createElement('div'); d.className='history-item';
                d.innerHTML=`<div>${h.text}</div><div style="font-size:10px;color:#666;margin-top:4px">${h.time}</div>`;
                d.onclick=()=>copyText(h.text, "å·²å¤åˆ¶");
                list.appendChild(d);
            });
        }
        function clearHistory() { copyHistory=[]; localStorage.setItem('copyHistory','[]'); renderHistory(); }
        function addToHistory(t) { copyHistory.unshift({text:t, time:new Date().toLocaleTimeString()}); if(copyHistory.length>20) copyHistory.pop(); localStorage.setItem('copyHistory', JSON.stringify(copyHistory)); }
        
        // ç¯ç®±
        function openLightbox(src, name) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox-link').href = `https://danbooru.donmai.us/posts?tags=${name}`;
            document.getElementById('lightbox').classList.add('open');
        }
        function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }
        function copySingle(name) { 
            const p = document.getElementById('check-prefix').checked ? 'artist:' : '';
            copyText(p+name, "å·²å¤åˆ¶");
        }

        document.getElementById('search').addEventListener('input', render);
        document.addEventListener('keydown', e => { if(e.key==='/') document.getElementById('search').focus(); });
    </script>
</body>
</html>
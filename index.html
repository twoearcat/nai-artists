<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelAI ç”»å¸ˆå†›ç«åº“</title>
    <style>
        :root {
            /* åŸºç¡€å˜é‡ */
            --primary-color: #4a90e2;
            --primary-hover: #357abd;
            --selected-border: #ff6b6b;
            --fav-color: #f1c40f;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --sub-text: #666;
            --border-color: #ddd;
            --panel-bg: #fff;
            --panel-shadow: 0 4px 20px rgba(0,0,0,0.08);
            --chip-bg: #eef2f7;
            --chip-text: #333;
        }

        /* æš—é»‘æ¨¡å¼ */
        body.dark-mode {
            --primary-color: #64b5f6;
            --primary-hover: #42a5f5;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --sub-text: #a0a0a0;
            --border-color: #333;
            --panel-bg: #1e1e1e;
            --panel-shadow: 0 4px 20px rgba(0,0,0,0.5);
            --chip-bg: #333;
            --chip-text: #ddd;
        }

        /* å…¨å±€å¹³æ»‘è¿‡æ¸¡ */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 20px; padding-bottom: 140px; /* ç•™ç»™å¤§è´­ç‰©è½¦ */
        }

        /* === é¡¶éƒ¨æ§åˆ¶æ  === */
        h1 { text-align: center; margin-bottom: 20px; font-weight: 300; letter-spacing: 1px; }
        .btn-gallery {
            background: #2ecc71; color: white; border: none; margin: 0 auto; display: block; margin-bottom: 20px;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; text-decoration: none; width: fit-content;
            transition: transform 0.2s;
        }
        .btn-gallery:hover { transform: translateY(-2px); }

        .controls {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            margin-bottom: 30px; background: var(--card-bg); padding: 20px;
            border-radius: 16px; box-shadow: var(--panel-shadow);
            max-width: 1000px; margin-left: auto; margin-right: auto; align-items: center;
        }

        .search-wrapper { flex-grow: 1; min-width: 300px; position: relative; }
        #search {
            width: 100%; padding: 12px 15px; padding-right: 40px; border-radius: 25px;
            border: 1px solid var(--border-color); font-size: 15px;
            transition: 0.3s; background: var(--bg-color); color: var(--text-color);
        }
        #search:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        .shortcut-hint {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            font-size: 12px; color: var(--sub-text); pointer-events: none;
            border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px;
        }

        .settings-group { display: flex; gap: 10px; align-items: center; }
        .btn-toggle {
            padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color);
            background: var(--card-bg); color: var(--sub-text); cursor: pointer;
            display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600;
            transition: all 0.2s; user-select: none;
        }
        .btn-toggle:hover { background: var(--bg-color); }
        .btn-toggle.active { background: #e3f2fd; border-color: var(--primary-color); color: var(--primary-color); }
        .btn-toggle-fav.active { background: #fff9db; border-color: var(--fav-color); color: #d35400; }
        
        /* æš—é»‘æ¨¡å¼é€‚é… */
        body.dark-mode .btn-toggle.active { background: #153552; }
        body.dark-mode .btn-toggle-fav.active { background: #3d3512; color: #f1c40f; }

        .switch-label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--sub-text); cursor: pointer; user-select: none; }
        .switch-input { display: none; }
        .switch-slider { width: 36px; height: 20px; background-color: #ccc; border-radius: 20px; position: relative; transition: 0.3s; }
        .switch-slider::before { content: ""; position: absolute; width: 16px; height: 16px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: 0.3s; }
        .switch-input:checked + .switch-slider { background-color: var(--primary-color); }
        .switch-input:checked + .switch-slider::before { transform: translateX(16px); }

        .gacha-box { display: flex; align-items: center; gap: 8px; padding-left: 15px; border-left: 1px solid var(--border-color); }
        #gacha-count { width: 45px; padding: 6px; border-radius: 6px; border: 1px solid var(--border-color); text-align: center; background: var(--bg-color); color: var(--text-color); }
        .btn-gacha { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-gacha:hover { background: var(--primary-hover); transform: translateY(-1px); }

        /* === å¡ç‰‡ç½‘æ ¼ === */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        
        .card {
            /* ...ä¿ç•™ä½ åŸæ¥çš„å…¶ä»– card æ ·å¼... */
            background: var(--card-bg); 
            border-radius: 12px; 
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; 
            border: 2px solid transparent; 
            display: flex; 
            flex-direction: column;
            content-visibility: auto; 
            contain-intrinsic-size: 1px 250px; /* é¢„ä¼°å¡ç‰‡é«˜åº¦ï¼Œé˜²æ­¢æ»šåŠ¨æ¡æŠ–åŠ¨ */
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .card.selected { border-color: var(--selected-border); background-color: rgba(255, 107, 107, 0.05); }

        .card-img-wrapper { width: 100%; height: 200px; cursor: zoom-in; overflow: hidden; background: #333; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s, transform 0.5s; }
        .card img.loaded { opacity: 1; }
        .card:hover img { transform: scale(1.08); }

        .card-actions { position: absolute; top: 6px; right: 6px; display: flex; flex-direction: column; gap: 6px; z-index: 10; }
        .action-btn {
            width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.95);
            border: 1px solid #ddd; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: 0.2s; opacity: 0.8; text-decoration: none;
        }
        body.dark-mode .action-btn { background: rgba(30,30,30,0.9); border-color: #555; color: #ccc; }
        .action-btn:hover { transform: scale(1.1); opacity: 1; }
        .btn-select.active { background: var(--selected-border); border-color: var(--selected-border); color: white; }
        .btn-fav.active { color: var(--fav-color); border-color: var(--fav-color); }

        .card-info { padding: 12px; text-align: center; cursor: pointer; border-top: 1px solid var(--border-color); flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .artist-name { font-weight: 600; font-size: 14px; word-break: break-all; }
        .card.selected .artist-name { color: var(--selected-border); }

        /* === åº•éƒ¨é«˜çº§è´­ç‰©è½¦ === */
        #cart-bar {
            position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 900px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            padding: 15px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 100; transition: bottom 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; gap: 10px; border: 1px solid rgba(255,255,255,0.2);
        }
        body.dark-mode #cart-bar { background: rgba(30, 30, 30, 0.9); border-color: rgba(255,255,255,0.05); }
        #cart-bar.show { bottom: 20px; }

        /* è´­ç‰©è½¦ï¼šç”»å¸ˆ Chip åˆ—è¡¨ */
        .cart-list {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scroll-behavior: smooth;
        }
        .cart-list::-webkit-scrollbar { height: 4px; }
        .cart-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        .cart-chip {
            background: var(--chip-bg); color: var(--chip-text); padding: 6px 12px; border-radius: 20px;
            font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; white-space: nowrap;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent; position: relative;
        }
        .cart-chip:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        .cart-chip .remove-btn { 
            width: 16px; height: 16px; border-radius: 50%; background: rgba(0,0,0,0.1); 
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }
        .cart-chip:hover .remove-btn { background: rgba(255,255,255,0.3); }

        /* è´­ç‰©è½¦ï¼šåº•éƒ¨æ“ä½œæ  */
        .cart-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .cart-actions { display: flex; gap: 10px; }
        .cart-btn {
            border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s;
        }
        .btn-copy { background: var(--primary-color); color: white; }
        .btn-copy:hover { background: var(--primary-hover); }
        .btn-clear { background: #eee; color: #555; }
        .btn-clear:hover { background: #ddd; }
        .btn-batch-fav { background: #fff9db; color: #d35400; border: 1px solid #ffeaa7; }
        .btn-batch-fav:hover { background: #ffeaa7; }
        body.dark-mode .btn-clear { background: #444; color: #ddd; }
        body.dark-mode .btn-batch-fav { background: #3d3512; color: #f1c40f; border-color: #554e15; }

        /* === æ‚¬æµ®é¢„è§ˆå°å›¾ === */
        #hover-preview {
            position: fixed; pointer-events: none; z-index: 2000;
            width: 120px; height: 120px; border-radius: 8px; overflow: hidden;
            background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0; transform: scale(0.8); transition: opacity 0.2s, transform 0.2s;
            border: 2px solid white;
        }
        #hover-preview.show { opacity: 1; transform: scale(1); }
        #hover-preview img { width: 100%; height: 100%; object-fit: cover; }

        /* === ä¾§è¾¹æ ä¸å†å² === */
        #history-panel {
            position: fixed; top: 0; right: -320px; width: 300px; height: 100%;
            background: var(--panel-bg); box-shadow: -5px 0 30px rgba(0,0,0,0.15);
            z-index: 2000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        #history-panel.open { right: 0; }
        .history-header { padding: 20px; border-bottom: 1px solid var(--border-color); font-weight: bold; display: flex; justify-content: space-between; }
        .history-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; margin-bottom: 8px; border-radius: 8px; background: var(--bg-color); border: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; }
        .history-item:hover { border-color: var(--primary-color); transform: translateX(-3px); }
        .history-text { font-size: 13px; margin-bottom: 5px; word-break: break-all; }
        .history-time { font-size: 11px; color: var(--sub-text); text-align: right; }

        /* === ç¯ç®± (å‡çº§ç‰ˆ) === */
        #lightbox {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000;
            justify-content: center; align-items: center; cursor: zoom-out; opacity: 0; transition: opacity 0.3s;
        }
        #lightbox.open { display: flex; opacity: 1; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; text-align: center; }
        .lightbox-content img { max-width: 100%; max-height: 90vh; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        /* ç¯ç®±å†…çš„æŒ‰é’® */
        .lightbox-btn-danbooru {
            position: absolute; bottom: 20px; right: 20px;
            background: #0075d8; color: white; padding: 8px 16px; border-radius: 20px;
            text-decoration: none; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .lightbox-btn-danbooru:hover { transform: scale(1.05); background: #299bf8; }

        /* === å›åˆ°é¡¶éƒ¨ (ç”¨æˆ·æŒ‡å®šæ ·å¼) === */
        .back-to-top {
            position: fixed; bottom: 30px; right: 30px;
            width: 50px; height: 50px; border-radius: 50%;
            background-color: var(--primary-color); color: white; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 900;
        }
        .back-to-top.show { opacity: 1; visibility: visible; bottom: 40px; }
        .back-to-top:hover { background-color: var(--primary-hover); transform: translateY(-3px); }

        .toast {
            visibility: hidden; min-width: 200px; background: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 12px 20px; position: fixed;
            z-index: 4000; left: 50%; top: 30px; transform: translateX(-50%) translateY(-20px);
            opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 500;
        }
        .toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        #overlay { display: none; position: fixed; inset: 0; z-index: 1999; }

    </style>
</head>
<body>

    <h1>NovelAI ç”»å¸ˆå†›ç«åº“</h1>
    
    <a href="gallery.html" class="btn-gallery">âœ¨ æŸ¥çœ‹æˆ‘çš„ç²¾é€‰ Prompt å›¾åº“</a>

    <div class="controls">
        <div class="search-wrapper">
            <input type="text" id="search" placeholder="è¾“å…¥ç”»å¸ˆåï¼Œæˆ–ç²˜è´´ Prompt...">
            <div class="shortcut-hint">/</div>
        </div>
        
        <div class="settings-group">
            <button class="btn-toggle" onclick="toggleHistory()" title="å†å²è®°å½•">ğŸ•’</button>
            <button class="btn-toggle" onclick="toggleDarkMode()" title="åˆ‡æ¢æ¨¡å¼">ğŸŒ—</button>
            <button class="btn-toggle btn-toggle-fav" id="btn-show-fav" onclick="toggleShowFav()" title="åªçœ‹æ”¶è—">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            </button>
            <label class="switch-label" title="å¤åˆ¶æ—¶è‡ªåŠ¨åŠ ä¸Š artist: å‰ç¼€">
                <input type="checkbox" id="check-prefix" class="switch-input" checked onchange="savePrefixSetting()">
                <div class="switch-slider"></div>
                <span style="font-size:12px">å‰ç¼€</span>
            </label>
        </div>

        <div class="gacha-box">
            <input type="number" id="gacha-count" value="3" min="1" max="50">
            <button class="btn-gacha" onclick="gacha()">ğŸ² å¸®æˆ‘é€‰</button>
        </div>
    </div>

    <div class="grid" id="gallery"></div>

    <!-- åº•éƒ¨è´­ç‰©è½¦ (UI å¤§æ”¹) -->
    <div id="cart-bar">
        <!-- ç”»å¸ˆ Chip åˆ—è¡¨ -->
        <div class="cart-list" id="cart-list"></div>
        
        <!-- åº•éƒ¨æ“ä½œåŒº -->
        <div class="cart-footer">
            <div class="cart-info">å·²é€‰ <span id="cart-count">0</span> ä½</div>
            <div class="cart-actions">
                <button class="cart-btn btn-batch-fav" onclick="batchFav()">â­ æ”¶è—å…¨éƒ¨</button>
                <button class="cart-btn btn-clear" onclick="clearCart()">æ¸…ç©º</button>
                <button class="cart-btn btn-copy" onclick="copyCart()">å¤åˆ¶ç»„åˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®é¢„è§ˆå°å›¾å®¹å™¨ -->
    <div id="hover-preview"><img src=""></div>

    <!-- å†å²è®°å½•é¢æ¿ -->
    <div id="history-panel">
        <div class="history-header">
            <span>ğŸ“‹ å¤åˆ¶å†å²</span>
            <span style="cursor:pointer" onclick="toggleHistory()">Ã—</span>
        </div>
        <div class="history-list" id="history-list"></div>
        <div style="padding:10px; border-top:1px solid var(--border-color); text-align:center;">
            <button class="cart-btn btn-clear" style="width:100%" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>
    </div>

    <!-- å›åˆ°é¡¶éƒ¨ -->
    <button id="backToTop" class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
    </button>

    <div id="overlay" onclick="toggleHistory()"></div>

    <!-- ç¯ç®± (å«è·³è½¬æŒ‰é’®) -->
    <div id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="">
            <a id="lightbox-link" href="#" target="_blank" class="lightbox-btn-danbooru">
                â†— Danbooru
            </a>
        </div>
    </div>
    
    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // === 1. åˆå§‹åŒ– ===
        const ICON_CHECK = 'âœ“';
        const ICON_STAR = '<svg viewBox="0 0 24 24" width="16" height="16"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="currentColor"/></svg>';
        const ICON_LINK = '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';

        let allArtists = [];
        let artistNameSet = new Set();
        let artistImageMap = {}; // æ–°å¢ï¼šç”¨äºæ‚¬æµ®é¢„è§ˆå¿«é€ŸæŸ¥æ‰¾å›¾ç‰‡
        let selectedArtists = new Set();
        let favArtists = new Set(JSON.parse(localStorage.getItem('favArtists') || '[]'));
        let isFavOnly = false;
        let copyHistory = JSON.parse(localStorage.getItem('copyHistory') || '[]');

        if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
        if (localStorage.getItem('usePrefix') === 'false') document.getElementById('check-prefix').checked = false;

        // å›åˆ°é¡¶éƒ¨ç›‘å¬
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('backToTop');
            if (window.scrollY > 300) btn.classList.add('show'); else btn.classList.remove('show');
        });

        fetch('artist_data.json')
            .then(res => res.json())
            .then(data => {
                allArtists = data.sort((a, b) => a.name.localeCompare(b.name));
                data.forEach(item => {
                    artistNameSet.add(item.name.toLowerCase());
                    artistImageMap[item.name] = item.image; // å»ºç«‹ç´¢å¼•
                });
                render();
            })
            .catch(e => console.error(e));

        const gallery = document.getElementById('gallery');
        const searchInput = document.getElementById('search');

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault(); searchInput.focus();
            }
            if (e.key === 'Escape') {
                closeLightbox();
                document.getElementById('history-panel').classList.remove('open');
                document.getElementById('overlay').style.display = 'none';
                if (document.activeElement === searchInput) searchInput.blur();
            }
        });

        // === 2. è´­ç‰©è½¦ UI é€»è¾‘ (New) ===
        
        function updateCartUI() {
            const listEl = document.getElementById('cart-list');
            listEl.innerHTML = ''; // æ¸…ç©ºé‡ç»˜
            
            selectedArtists.forEach(name => {
                const chip = document.createElement('div');
                chip.className = 'cart-chip';
                chip.innerHTML = `${name} <div class="remove-btn">Ã—</div>`;
                
                // ç‚¹å‡»åå­—æ‰“å¼€ç¯ç®±
                chip.onclick = (e) => {
                    e.stopPropagation();
                    openLightbox(artistImageMap[name], name);
                };
                
                // ç‚¹å‡»åˆ é™¤æŒ‰é’®
                const closeBtn = chip.querySelector('.remove-btn');
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleSelection(name);
                };

                // æ‚¬åœé¢„è§ˆ
                chip.onmouseenter = (e) => showHoverPreview(e, name);
                chip.onmouseleave = () => hideHoverPreview();

                listEl.appendChild(chip);
            });

            const count = selectedArtists.size;
            document.getElementById('cart-count').innerText = count;
            const bar = document.getElementById('cart-bar');
            count > 0 ? bar.classList.add('show') : bar.classList.remove('show');
        }

        // æ‚¬æµ®é¢„è§ˆé€»è¾‘
        function showHoverPreview(e, name) {
            const previewBox = document.getElementById('hover-preview');
            const img = previewBox.querySelector('img');
            const url = artistImageMap[name];
            if (!url) return;

            img.src = url;
            previewBox.classList.add('show');

            // è®¡ç®—ä½ç½®ï¼šæ˜¾ç¤ºåœ¨ Chip çš„ä¸Šæ–¹
            const rect = e.target.getBoundingClientRect();
            // å±…ä¸­å¯¹é½ Chip
            let left = rect.left + (rect.width / 2) - 60; 
            let top = rect.top - 130; // ä¸Šæ–¹ 130px

            // ç®€å•é˜²æº¢å‡º
            if (left < 10) left = 10;
            if (top < 10) top = rect.bottom + 10; // å¦‚æœä¸Šæ–¹æ²¡åœ°å„¿äº†ï¼Œå°±æ”¾ä¸‹æ–¹

            previewBox.style.left = `${left}px`;
            previewBox.style.top = `${top}px`;
        }

        function hideHoverPreview() {
            document.getElementById('hover-preview').classList.remove('show');
        }

        // æ‰¹é‡æ”¶è—
        function batchFav() {
            if (selectedArtists.size === 0) return;
            let addedCount = 0;
            selectedArtists.forEach(name => {
                if (!favArtists.has(name)) {
                    favArtists.add(name);
                    addedCount++;
                }
            });
            localStorage.setItem('favArtists', JSON.stringify([...favArtists]));
            render(); // åˆ·æ–°æ˜Ÿæ˜ŸçŠ¶æ€
            showToast(`å·²å°† ${selectedArtists.size} ä½ç”»å¸ˆåŠ å…¥æ”¶è—`);
        }

        // === 3. ç¯ç®±é€»è¾‘ (New) ===
        function openLightbox(src, name) {
            const lb = document.getElementById('lightbox');
            document.getElementById('lightbox-img').src = src;
            
            // æ›´æ–° Danbooru é“¾æ¥
            const linkBtn = document.getElementById('lightbox-link');
            if (name) {
                linkBtn.href = `https://danbooru.donmai.us/posts?tags=${name}`;
                linkBtn.style.display = 'flex';
            } else {
                linkBtn.style.display = 'none';
            }
            
            lb.classList.add('open'); // ä½¿ç”¨ class æ§åˆ¶ fade in
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('open');
        }

        // === 4. å¸¸è§„é€»è¾‘ (ä¿æŒä¸å˜) ===
        function toggleHistory() {
            const panel = document.getElementById('history-panel');
            const overlay = document.getElementById('overlay');
            if (panel.classList.contains('open')) {
                panel.classList.remove('open'); overlay.style.display = 'none';
            } else {
                renderHistoryList(); panel.classList.add('open'); overlay.style.display = 'block';
            }
        }
        function addToHistory(text) {
            if (copyHistory.length > 0 && copyHistory[0].text === text) return;
            copyHistory.unshift({ text, time: new Date().toLocaleTimeString() });
            if (copyHistory.length > 30) copyHistory.pop();
            localStorage.setItem('copyHistory', JSON.stringify(copyHistory));
        }
        function renderHistoryList() {
            const listEl = document.getElementById('history-list'); listEl.innerHTML = '';
            copyHistory.forEach(item => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div class="history-text">${item.text}</div><div class="history-time">${item.time}</div>`;
                div.onclick = () => { navigator.clipboard.writeText(item.text).then(() => { showToast("å·²é‡æ–°å¤åˆ¶"); toggleHistory(); }); };
                listEl.appendChild(div);
            });
            if (copyHistory.length === 0) listEl.innerHTML = "<p style='text-align:center;color:var(--sub-text)'>æš‚æ— è®°å½•</p>";
        }
        function clearHistory() { copyHistory = []; localStorage.setItem('copyHistory', '[]'); renderHistoryList(); }
        function copyText(text, msg) { navigator.clipboard.writeText(text).then(() => { showToast(msg); addToHistory(text); }); }

        function render() {
            gallery.innerHTML = '';
            let rawTerm = searchInput.value;
            let filtered = [];
            
            if (rawTerm.includes(',') || rawTerm.includes('ï¼Œ')) {
                const segments = rawTerm.split(/[,ï¼Œ]/);
                const foundNames = new Set();
                segments.forEach(seg => {
                    let s = seg.toLowerCase().trim();
                    if(!s) return;
                    s = s.replace(/artist:/g, '').replace(/[\[\]\{\}]/g, '');
                    // ç®€æ˜“æ¸…æ´—é€»è¾‘
                    if(artistNameSet.has(s)) { foundNames.add(s); return; }
                    let s_dash = s.replace(/ /g, '_');
                    if(artistNameSet.has(s_dash)) foundNames.add(s_dash);
                });
                filtered = allArtists.filter(item => foundNames.has(item.name.toLowerCase()));
            } else {
                let term = rawTerm.toLowerCase().trim();
                filtered = allArtists.filter(item => item.name.toLowerCase().includes(term));
            }
            if (isFavOnly) filtered = filtered.filter(item => favArtists.has(item.name));

            if (filtered.length === 0) {
                gallery.innerHTML = "<p style='text-align:center;width:100%;color:var(--sub-text)'>æ— åŒ¹é…ç»“æœ</p>"; return;
            }

            filtered.forEach(item => {
                const isSelected = selectedArtists.has(item.name);
                const isFav = favArtists.has(item.name);
                const card = document.createElement('div');
                card.className = `card ${isSelected ? 'selected' : ''}`;
                card.dataset.name = item.name;

                const actions = document.createElement('div'); actions.className = 'card-actions';
                actions.append(
                    createBtn('btn-select', isSelected, ICON_CHECK, () => toggleSelection(item.name)),
                    createBtn('btn-fav', isFav, ICON_STAR, () => toggleFav(item.name)),
                    createLinkBtn(item.name)
                );

                const imgWrapper = document.createElement('div'); imgWrapper.className = 'card-img-wrapper';
                imgWrapper.onclick = () => openLightbox(item.image, item.name); // ä¼ å…¥åå­—
                const img = document.createElement('img'); img.loading = "lazy"; img.src = item.image;
                img.onload = () => img.classList.add('loaded');
                img.onerror = function() { this.src = 'https://via.placeholder.com/200?text=Err'; this.classList.add('loaded'); };
                imgWrapper.appendChild(img);

                const info = document.createElement('div'); info.className = 'card-info';
                info.innerHTML = `<div class="artist-name">${item.name}</div>`;
                info.onclick = () => copySingle(item.name);

                card.append(actions, imgWrapper, info); gallery.appendChild(card);
            });
            // æ¯æ¬¡æ¸²æŸ“ä¹Ÿæ›´æ–°è´­ç‰©è½¦UIï¼Œé˜²æ­¢çŠ¶æ€ä¸åŒæ­¥
            updateCartUI();
        }

        function createBtn(cls, active, html, cb) {
            const d = document.createElement('div'); d.className = `action-btn ${cls} ${active ? 'active' : ''}`;
            d.innerHTML = html; d.onclick = (e) => { e.stopPropagation(); cb(); render(); }; return d;
        }
        function createLinkBtn(name) {
            const a = document.createElement('a'); a.className = 'action-btn btn-link'; a.innerHTML = ICON_LINK;
            a.href = `https://danbooru.donmai.us/posts?tags=${name}`; a.target = "_blank"; a.onclick = (e) => e.stopPropagation(); return a;
        }

        function toggleFav(name) {
            if (favArtists.has(name)) favArtists.delete(name); else favArtists.add(name);
            localStorage.setItem('favArtists', JSON.stringify([...favArtists]));
            if (isFavOnly) render();
        }
        function toggleShowFav() {
            isFavOnly = !isFavOnly;
            document.getElementById('btn-show-fav').classList.toggle('active', isFavOnly); render();
        }
        function toggleSelection(name) {
            if (selectedArtists.has(name)) selectedArtists.delete(name); else selectedArtists.add(name);
            render(); // ä¼šè‡ªåŠ¨è°ƒç”¨ updateCartUI
        }

        function getPrefix() { return document.getElementById('check-prefix').checked ? 'artist:' : ''; }
        function savePrefixSetting() { localStorage.setItem('usePrefix', document.getElementById('check-prefix').checked); }
        function copySingle(name) { copyText(`${getPrefix()}${name}`, `å·²å¤åˆ¶: ${getPrefix()}${name}`); }
        function copyCart() {
            if (selectedArtists.size === 0) return;
            const tags = Array.from(selectedArtists).map(t => `${getPrefix()}${t}`).join(', ');
            copyText(tags, `å·²å¤åˆ¶ ${selectedArtists.size} ä½ç”»å¸ˆï¼`);
        }
        function clearCart() { selectedArtists.clear(); render(); }
        
        function toggleDarkMode() {
            // 1. å®šä¹‰åˆ‡æ¢é€»è¾‘
            const updateDOM = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            };

            // 2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ View Transitions API (Chrome/Edge 111+ æ”¯æŒ)
            if (!document.startViewTransition) {
                updateDOM(); // ä¸æ”¯æŒåˆ™ç›´æ¥åˆ‡æ¢
                return;
            }

            // 3. å¼€å§‹ä¸æ»‘è¿‡æ¸¡
            document.startViewTransition(() => {
                updateDOM();
            });
        }
        function gacha() {
            let pool = [];
            if (searchInput.value.trim()) document.querySelectorAll('.card').forEach(c => pool.push(c.dataset.name));
            else pool = isFavOnly ? Array.from(favArtists) : allArtists.map(a => a.name);
            
            if (pool.length === 0) { showToast("åˆ—è¡¨ä¸ºç©º"); return; }
            let count = Math.min(parseInt(document.getElementById('gacha-count').value)||3, 50);
            
            let added = 0; let attempts = 0;
            while(added < count && attempts < count * 10) {
                attempts++;
                const r = pool[Math.floor(Math.random() * pool.length)];
                if (!selectedArtists.has(r)) { selectedArtists.add(r); added++; }
                if (selectedArtists.size >= allArtists.length) break;
            }
            render(); showToast(added > 0 ? `ğŸ‰ æŠ½å– ${added} ä½` : "âš ï¸ æ²¡æŠ½åˆ°æ–°çš„");
        }
        function showToast(m) { const t=document.getElementById("toast"); t.innerText=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2000); }
        searchInput.addEventListener('input', render);
    </script>
</body>
</html>